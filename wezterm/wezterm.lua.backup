-- WezTerm 설정
local wezterm = require 'wezterm'
local config = {}

-- 버전에 따른 config builder 사용
if wezterm.config_builder then
  config = wezterm.config_builder()
end

-- 기본 설정
config.automatically_reload_config = true
config.use_ime = true

-- 폰트 설정 (Ghostty와 동일)
config.font = wezterm.font_with_fallback {
  'JetBrainsMono Nerd Font Mono',
  'D2Coding',
  'Apple SD Gothic Neo',
}
config.font_size = 16.0
config.line_height = 1.125  -- Ghostty의 12.5% 증가와 유사

-- 색상 테마 (Dracula + Ghostty 커스텀)
config.color_scheme = 'Dracula'

-- Ghostty와 동일한 배경색 오버라이드
config.colors = {
  background = '#191B21',  -- Ghostty의 커스텀 배경색
  
  -- 탭바 색상도 배경색과 통일
  tab_bar = {
    background = '#191B21',
    active_tab = {
      bg_color = '#191B21',
      fg_color = '#FFFFFF',
    },
    inactive_tab = {
      bg_color = '#191B21', 
      fg_color = '#CCCCCC',
    },
    inactive_tab_hover = {
      bg_color = '#232530',
      fg_color = '#FFFFFF',
    },
    new_tab = {
      bg_color = '#191B21',
      fg_color = '#CCCCCC',
    },
    new_tab_hover = {
      bg_color = '#232530',
      fg_color = '#FFFFFF',
    },
  },
}

-- 창 설정
config.window_background_opacity = 1.0  -- Ghostty와 동일 (불투명)
config.window_decorations = "INTEGRATED_BUTTONS|RESIZE"  -- 통합된 traffic light 버튼

-- 타이틀바와 탭바 색상을 배경색과 통일
config.window_frame = {
  inactive_titlebar_bg = '#191B21',
  active_titlebar_bg = '#191B21',
  inactive_titlebar_fg = '#CCCCCC',  -- 텍스트는 밝은 색으로
  active_titlebar_fg = '#FFFFFF',    -- 활성 창 텍스트는 흰색
  inactive_titlebar_border_bottom = '#191B21',
  active_titlebar_border_bottom = '#191B21',
  font_size = 12.0,
}

-- 패딩 설정 (INTEGRATED_BUTTONS 모드에서도 시도)
config.window_padding = {
  left = '10px',
  right = '10px', 
  top = '1.5cell',    -- 1.5cell로 조정
  bottom = '0px',
}

-- 탭 바 설정
config.enable_tab_bar = true
config.hide_tab_bar_if_only_one_tab = true
config.tab_bar_at_bottom = false
config.use_fancy_tab_bar = true

-- 스크롤백
config.scrollback_lines = 10000

-- 커서 설정
config.default_cursor_style = 'BlinkingBlock'
config.cursor_blink_rate = 500

-- macOS 특정 설정
config.native_macos_fullscreen_mode = true
config.window_close_confirmation = 'AlwaysPrompt'

-- Quick Select 설정 (패턴 자동 인식)
config.quick_select_patterns = {
  -- 기본 패턴들
  'https?://[^\\s]+',                    -- URL
  '/[^\\s]+',                            -- 파일 경로
  '[a-f0-9]{7,40}',                      -- Git 해시
  '[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+',  -- IPv4
  '[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+',   -- 이메일
  -- 커스텀 패턴 추가
  '[A-Z]+-[0-9]+',                       -- JIRA 티켓
  '@[a-zA-Z0-9_]+',                      -- 멘션
  '#[0-9]+',                             -- 이슈 번호
  '[0-9]{4}-[0-9]{2}-[0-9]{2}',         -- 날짜 형식
}
config.quick_select_alphabet = 'asdfghjklqwertyuiop'  -- 라벨 순서

-- 키 바인딩
local act = wezterm.action
config.keys = {
  -- 설정 다시 로드
  {
    key = 'r',
    mods = 'CMD|SHIFT',
    action = act.ReloadConfiguration,
  },
  
  -- Copy Mode 활성화 (vim 스타일 텍스트 선택)
  {
    key = 'x',
    mods = 'CMD|SHIFT',
    action = act.ActivateCopyMode,
  },
  
  -- Quick Select Mode (패턴 자동 인식 및 빠른 선택)
  {
    key = 'u',
    mods = 'CMD|SHIFT',
    action = act.QuickSelect,
  },
  
  -- 패널 분할 (Ghostty와 동일)
  {
    key = '\\',
    mods = 'CMD|SHIFT',
    action = act.SplitHorizontal { domain = 'CurrentPaneDomain' },
  },
  {
    key = '-',
    mods = 'CMD|SHIFT',
    action = act.SplitVertical { domain = 'CurrentPaneDomain' },
  },
  
  -- 패널 네비게이션 (vim 스타일)
  {
    key = 'h',
    mods = 'CMD|SHIFT',
    action = act.ActivatePaneDirection 'Left',
  },
  {
    key = 'j',
    mods = 'CMD|SHIFT',
    action = act.ActivatePaneDirection 'Down',
  },
  {
    key = 'k',
    mods = 'CMD|SHIFT',
    action = act.ActivatePaneDirection 'Up',
  },
  {
    key = 'l',
    mods = 'CMD|SHIFT',
    action = act.ActivatePaneDirection 'Right',
  },
  
  -- 패널 크기 조정
  {
    key = 'h',
    mods = 'CMD|CTRL',
    action = act.AdjustPaneSize { 'Left', 5 },
  },
  {
    key = 'j',
    mods = 'CMD|CTRL',
    action = act.AdjustPaneSize { 'Down', 5 },
  },
  {
    key = 'k',
    mods = 'CMD|CTRL',
    action = act.AdjustPaneSize { 'Up', 5 },
  },
  {
    key = 'l',
    mods = 'CMD|CTRL',
    action = act.AdjustPaneSize { 'Right', 5 },
  },
  
  -- 패널 닫기
  {
    key = 'w',
    mods = 'CMD',
    action = act.CloseCurrentPane { confirm = true },
  },
  
  -- 탭 관리
  {
    key = 't',
    mods = 'CMD',
    action = act.SpawnTab 'CurrentPaneDomain',
  },
  {
    key = 'w',
    mods = 'CMD|SHIFT',
    action = act.CloseCurrentTab { confirm = true },
  },
  
  -- 탭 네비게이션
  {
    key = '1',
    mods = 'CMD',
    action = act.ActivateTab(0),
  },
  {
    key = '2',
    mods = 'CMD',
    action = act.ActivateTab(1),
  },
  {
    key = '3',
    mods = 'CMD',
    action = act.ActivateTab(2),
  },
  {
    key = '4',
    mods = 'CMD',
    action = act.ActivateTab(3),
  },
  {
    key = '5',
    mods = 'CMD',
    action = act.ActivateTab(4),
  },
  {
    key = '6',
    mods = 'CMD',
    action = act.ActivateTab(5),
  },
  {
    key = '7',
    mods = 'CMD',
    action = act.ActivateTab(6),
  },
  {
    key = '8',
    mods = 'CMD',
    action = act.ActivateTab(7),
  },
  {
    key = '9',
    mods = 'CMD',
    action = act.ActivateTab(-1),
  },
  
  -- 복사/붙여넣기
  {
    key = 'c',
    mods = 'CMD',
    action = act.CopyTo 'Clipboard',
  },
  {
    key = 'v',
    mods = 'CMD',
    action = act.PasteFrom 'Clipboard',
  },
  
  -- 검색
  {
    key = 'f',
    mods = 'CMD',
    action = act.Search 'CurrentSelectionOrEmptyString',
  },
  
  -- 전체화면
  {
    key = 'Enter',
    mods = 'CMD|SHIFT',
    action = act.ToggleFullScreen,
  },
  
  -- 폰트 크기 조정
  {
    key = '+',
    mods = 'CMD',
    action = act.IncreaseFontSize,
  },
  {
    key = '-',
    mods = 'CMD',
    action = act.DecreaseFontSize,
  },
  {
    key = '0',
    mods = 'CMD',
    action = act.ResetFontSize,
  },
}

-- 마우스 바인딩
config.mouse_bindings = {
  -- URL 클릭으로 열기
  {
    event = { Up = { streak = 1, button = 'Left' } },
    mods = 'CMD',
    action = act.OpenLinkAtMouseCursor,
  },
  
  -- 우클릭으로 붙여넣기
  {
    event = { Up = { streak = 1, button = 'Right' } },
    mods = 'NONE',
    action = act.PasteFrom 'Clipboard',
  },
}

-- hyperlink 설정
config.hyperlink_rules = wezterm.default_hyperlink_rules()

-- Copy Mode 키 테이블 (vim 스타일)
config.key_tables = {
  copy_mode = {
    -- 이동 (vim 기본)
    { key = 'h', mods = 'NONE', action = act.CopyMode 'MoveLeft' },
    { key = 'j', mods = 'NONE', action = act.CopyMode 'MoveDown' },
    { key = 'k', mods = 'NONE', action = act.CopyMode 'MoveUp' },
    { key = 'l', mods = 'NONE', action = act.CopyMode 'MoveRight' },
    
    -- 단어 단위 이동
    { key = 'w', mods = 'NONE', action = act.CopyMode 'MoveForwardWord' },
    { key = 'b', mods = 'NONE', action = act.CopyMode 'MoveBackwardWord' },
    { key = 'e', mods = 'NONE', action = act.CopyMode 'MoveForwardWordEnd' },
    
    -- 줄 시작/끝
    { key = '0', mods = 'NONE', action = act.CopyMode 'MoveToStartOfLine' },
    { key = '$', mods = 'NONE', action = act.CopyMode 'MoveToEndOfLineContent' },
    { key = '^', mods = 'NONE', action = act.CopyMode 'MoveToStartOfLineContent' },
    
    -- 화면 이동
    { key = 'H', mods = 'NONE', action = act.CopyMode 'MoveToViewportTop' },
    { key = 'M', mods = 'NONE', action = act.CopyMode 'MoveToViewportMiddle' },
    { key = 'L', mods = 'NONE', action = act.CopyMode 'MoveToViewportBottom' },
    
    -- 스크롤
    { key = 'G', mods = 'NONE', action = act.CopyMode 'MoveToScrollbackBottom' },
    { key = 'g', mods = 'NONE', action = act.CopyMode 'MoveToScrollbackTop' },
    { key = 'u', mods = 'CTRL', action = act.CopyMode { MoveByPage = -0.5 } },
    { key = 'd', mods = 'CTRL', action = act.CopyMode { MoveByPage = 0.5 } },
    { key = 'f', mods = 'CTRL', action = act.CopyMode 'PageDown' },
    { key = 'b', mods = 'CTRL', action = act.CopyMode 'PageUp' },
    
    -- 선택 모드
    { key = 'v', mods = 'NONE', action = act.CopyMode { SetSelectionMode = 'Cell' } },
    { key = 'V', mods = 'NONE', action = act.CopyMode { SetSelectionMode = 'Line' } },
    { key = 'v', mods = 'CTRL', action = act.CopyMode { SetSelectionMode = 'Block' } },
    { key = 'Space', mods = 'NONE', action = act.CopyMode { SetSelectionMode = 'Cell' } },
    
    -- 선택 영역 조정
    { key = 'o', mods = 'NONE', action = act.CopyMode 'MoveToSelectionOtherEnd' },
    { key = 'O', mods = 'NONE', action = act.CopyMode 'MoveToSelectionOtherEndHoriz' },
    
    -- 검색 (vim의 f/F/t/T)
    { key = 'f', mods = 'NONE', action = act.CopyMode { JumpForward = { prev_char = false } } },
    { key = 'F', mods = 'NONE', action = act.CopyMode { JumpBackward = { prev_char = false } } },
    { key = 't', mods = 'NONE', action = act.CopyMode { JumpForward = { prev_char = true } } },
    { key = 'T', mods = 'NONE', action = act.CopyMode { JumpBackward = { prev_char = true } } },
    { key = ';', mods = 'NONE', action = act.CopyMode 'JumpAgain' },
    { key = ',', mods = 'NONE', action = act.CopyMode 'JumpReverse' },
    
    -- 복사 및 종료
    {
      key = 'y',
      mods = 'NONE',
      action = act.Multiple {
        { CopyTo = 'ClipboardAndPrimarySelection' },
        { CopyMode = 'Close' }
      }
    },
    
    -- 종료
    { key = 'q', mods = 'NONE', action = act.CopyMode 'Close' },
    { key = 'Escape', mods = 'NONE', action = act.CopyMode 'Close' },
    {
      key = 'c',
      mods = 'CTRL',
      action = act.CopyMode 'Close'
    },
    
    -- 다음 줄로
    { key = 'Enter', mods = 'NONE', action = act.CopyMode 'MoveToStartOfNextLine' },
  },
  
  -- Search Mode (Copy Mode 내에서 /와 ?로 검색)
  search_mode = {
    { key = 'Enter', mods = 'NONE', action = act.CopyMode 'PriorMatch' },
    { key = 'n', mods = 'CTRL', action = act.CopyMode 'NextMatch' },
    { key = 'p', mods = 'CTRL', action = act.CopyMode 'PriorMatch' },
    { key = 'r', mods = 'CTRL', action = act.CopyMode 'CycleMatchType' },
    { key = 'u', mods = 'CTRL', action = act.CopyMode 'ClearPattern' },
    { key = 'Escape', mods = 'NONE', action = act.CopyMode 'Close' },
  },
}

return config